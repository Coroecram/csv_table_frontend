<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Michael Budnick Submission</title>
  <meta name="description" content="Michael Budnick Genesis Trading Submission">
  <meta name="author" content="Michael Budnick">

  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/tabulator.css">
  <link rel="stylesheet" href="css/jquery-ui.css">
  <link rel="stylesheet" href="css/jquery-ui.theme.css">
  <link rel="stylesheet" href="css/jquery-ui.structure.css">

</head>

<body>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/jquery-ui.min.js"></script>
  <script src="js/tabulator.min.js"></script>
  <script src="js/papaparse.min.js"></script>
  <script src="js/util.js"></script>
  <script src="js/script.js"></script>

  <input id="upload" type="file" accept=".csv" />
  <div id="csv-table"></div>
  <ul id="filters">Filters
  </ul>
  <p id="add-filter">+</p>

  <script id="csv-uploading">
    var data;
    var columns = [];
    var columnInfo = [];
    var columnTitles = [];

    document.getElementById("upload").addEventListener("change", upload, false);
    document.getElementById("add-filter").addEventListener("click", addFilter, false);
    $("#filters").hide();
    $("#add-filter").hide();

    function upload(e) {
      var file = e.target.files[0];

      var reader = new FileReader();
      reader.readAsText(file);
      reader.onload = function (event) {
          var csvData = event.target.result;

          var parsedCSV = Papa.parse(csvData, {'header': true, 'dynamicTyping': true});

          data = parsedCSV.data;
          var headers = Object.keys(data[0])
          console.log(headers)
          columns = [];

          for (var i = 0; i < headers.length; i++) {
            columnInfo.push({'name': headers[i], 'type': typeof(data[0][headers[i]])})
            columnTitles.push(toTitleCase(headers[i]));
            columns.push({ 'title': toTitleCase(headers[i]),
            'field': headers[i],
            'sortable': true });
          }

          $("#csv-table").tabulator({'columns': columns,
                                      'layout':"fitColumns",
                                      'addRowPos':"top",
                                      'pagination':"local",
                                      'paginationSize':7,
                                      'movableColumns':true,
                                      'resizableRows':true
                                    });
          $("#csv-table").tabulator("setData", data.slice(0,-1));
          $("#filters").show();
          $("#add-filter").show();
      }

    }

    var TEXT_OPERATORS = ['=', '!=', '&lt;', '&gt;', '&lt;=', '&gt;=', 'IN', 'LIKE'];
    var NUM_OPERATORS  = ['=', '!=', '&lt;', '&gt;', '&lt;=', '&gt;='];
    var textOpSelector = ['<select class="filter-op$', 'filter-op-0', '" >'];
    var numOpSelector  = ['<select class="filter-op$', 'filter-op-0', '" >']; // Need $ as spaceholder, join trims space
    var filtersApplied = [];
    var filterRow = [];
    var filterIdx = 0;
    var newFilter = '';
    var filters = [];

    function removeFilter(filters, filter) {
      for(var i = 0;i < filters.length;i++) {
        if (filters[i].field == filter.field &
            filters[i].type == filter.type &
            filters[i].value == filter.value) {
              filters.splice(i, 1);
        }
      }
    }

    function pushFilter(filters, filter) {
      var dupFilter = false;
      console.log(filter);
      for(var i = 0;i < filters.length;i++) {
        if (filters[i].field == filter.field &
            filters[i].type  == filter.type &
            filters[i].value == filter.value) {
              dupFilter = true;
        }
      }

      if(dupFilter) {
        return false;
      } else {
        filters.push(filter);
        console.log(filters);
        return true;
      }
    }

    for (var i = 0; i < TEXT_OPERATORS.length; i++) {
      textOpSelector.push('<option value="' + TEXT_OPERATORS[i] + '" >' + TEXT_OPERATORS[i] + '</option>')
    }
    textOpSelector.push("</select>");

    for (var i = 0; i < NUM_OPERATORS.length; i++) {
      numOpSelector.push('<option value="' + NUM_OPERATORS[i] + '" >' + NUM_OPERATORS[i] + '</option>')
    }
    numOpSelector.push("</select>");

    function addFilter() {
      filterRow = [];

      var filterIdxClass = 'filter-' + filterIdx;
      var filterColIdx = 'filter-col-' + filterIdx;
      var filterOpIdx = 'filter-op-' + filterIdx;
      var filterValIdx = 'filter-value-' + filterIdx;
      var filterConfirmIdx = 'filter-confirm-' + filterIdx;
      var filterRemoveIdx = 'filter-remove-' + filterIdx;
      filterIdx++;

      var opSelector = columnInfo[0].type == "string" ? textOpSelector : numOpSelector;
      if(filterIdx > 0) {
        opSelector.splice(1, 1, filterOpIdx);
      }
      var strOpElement = opSelector.join("").replace("$", " ");

      filterRow.push('<li id="filter' + filterIdxClass + '" >')
      filterRow.push("<select class='filter-col " + filterColIdx + "' >")
      for (var i = 0; i < columnInfo.length; i++) {
        filterRow.push("<option value=" + columnInfo[i].name + ">" + columnTitles[i] + "</option>")
      }
      filterRow.push("</select>");
      filterRow.push(strOpElement);
      filterRow.push('<input class="filter-value ' + filterValIdx + '" type="text"></input>');
      filterRow.push('<span class="filter-confirm ' + filterConfirmIdx + '">&#9989</span>');
      filterRow.push('<span class="filter-remove ' + filterRemoveIdx + '" >&#10006</span>');
      filterRow.push("</li>");
      filterRow = filterRow.join("");
      newFilter = filterConfirmIdx;
      $("#add-filter").hide();
      $("#filters").append(filterRow);

      $('.' + filterRemoveIdx).hide();
      $('.' + filterColIdx).on('change', filterColEdited);
      $('.' + filterOpIdx).on('change', filterOpEdited);
      $('.' + filterValIdx).on('input', function() {
        filterValEdited($(filterConfirmIdx), );
      });

      $('.' + filterConfirmIdx).on('click', function() {
        var column = $('.' + filterColIdx).val();
        var operator = $('.' + filterOpIdx).val();
        var value = $('.' + filterValIdx).val();
        var filterAdded = pushFilter(filters, {
              'field': column,
              'type': operator,
              'value': value
        })
        console.log('filterAdded ' + filterAdded);

        if (filterAdded) {
          $(this).hide();
          $("#csv-table").tabulator("setFilter", filters);

          $('.' + filterRemoveIdx).show()
          if(newFilter == filterConfirmIdx) {
            $("#add-filter").show();
            newFilter = '';
          }
        }
      })

      $('.' + filterRemoveIdx).on('click', function() {
        var column = $('.' + filterColIdx).val();
        var operator = $('.' + filterOpIdx).val();
        var value = $('.' + filterValIdx).val();

        console.log("column " + column);
        console.log("operator " + operator);
        console.log("value " + value);
        removeFilter(filters, {'field': column,
                               'type': operator,
                               'value': value })

        console.log(filters);

        $("#csv-table").tabulator("setFilter", filters);

        $('.' + filterRemoveIdx).parent().remove();
      })
    }

    function filterColEdited() {
      var index = $(this).parent().prevAll().length;
      $('.filter-op').replaceWith();
    }

    function filterOpEdited() {
      console.log("edit");
    }

    function filterValEdited(confirmEle) {
      confirmEle.show();
    }

  </script>



</body>
</html>
