<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Michael Budnick Submission</title>
  <meta name="description" content="Michael Budnick Genesis Trading Submission">
  <meta name="author" content="Michael Budnick">

  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/tabulator.css">
  <link rel="stylesheet" href="css/jquery-ui.css">
  <link rel="stylesheet" href="css/jquery-ui.theme.css">
  <link rel="stylesheet" href="css/jquery-ui.structure.css">

</head>

<body>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/jquery-ui.min.js"></script>
  <script src="js/tabulator.min.js"></script>
  <script src="js/papaparse.min.js"></script>
  <script src="js/util.js"></script>
  <script src="js/script.js"></script>

  <input id="upload" type="file" accept=".csv" />
  <div id="csv-table"></div>
  <ul id="filters">Filters
  </ul>
  <p id="add-filter">+</p>

  <script id="csv-uploading">
    var data;
    var columns = [];
    var columnInfo = [];
    var columnTitles = [];

    document.getElementById("upload").addEventListener("change", upload, false);
    document.getElementById("add-filter").addEventListener("click", addFilter, false);
    $("#filters").hide();
    $("#add-filter").hide();

    function upload(e) {
      var file = e.target.files[0];

      var reader = new FileReader();
      reader.readAsText(file);
      reader.onload = function (event) {
          var csvData = event.target.result;

          var parsedCSV = Papa.parse(csvData, {'header': true, 'dynamicTyping': true});

          data = parsedCSV.data;
          var headers = Object.keys(data[0])
          console.log(headers)
          columns = [];

          for (var i = 0; i < headers.length; i++) {
            columnInfo.push({'name': headers[i], 'type': typeof(data[0][headers[i]])})
            columnTitles.push(toTitleCase(headers[i]));
            columns.push({ 'title': toTitleCase(headers[i]),
            'field': headers[i],
            'sortable': true });
          }

          $("#csv-table").tabulator({'columns': columns,
                                      'layout':"fitColumns",
                                      'addRowPos':"top",
                                      'pagination':"local",
                                      'paginationSize':7,
                                      'movableColumns':true,
                                      'resizableRows':true
                                    });
          $("#csv-table").tabulator("setData", data.slice(0,-1));
          $("#filters").show();
          $("#add-filter").show();
      }

    }

    var TEXT_OPERATORS = ['=', '!=', '&lt;', '&gt;', '&lt;=', '&gt;=', 'IN', 'LIKE'];
    var NUM_OPERATORS  = ['=', '!=', '&lt;', '&gt;', '&lt;=', '&gt;='];
    var textOpSelector = ['<select class="filter-op', " ", '>'];
    var numOpSelector  = ['<select class="filter-op$', '" >']; // Need $ as spaceholder, join trims space
    var filtersApplied = [];
    var filterRow = [];

    for (var i = 0; i < TEXT_OPERATORS.length; i++) {
      textOpSelector.push('<option value="' + TEXT_OPERATORS[i] + '" >' + TEXT_OPERATORS[i] + '</option>')
    }
    textOpSelector.push("</select>");

    for (var i = 0; i < NUM_OPERATORS.length; i++) {
      numOpSelector.push('<option value="' + NUM_OPERATORS[i] + '" >' + NUM_OPERATORS[i] + '</option>')
    }
    numOpSelector.push("</select>");

    function addFilter() {
      filterRow = [];
      var filterIdx = $('#filters')[0].childElementCount;

      var filterIdxClass = 'filter-' + filterIdx;
      var filterColIdx = 'filter-col-' + filterIdx;
      var filterOpIdx = 'filter-op-' + filterIdx;
      var filterValIdx = 'filter-value-' + filterIdx;
      var filterConfirmIdx = 'filter-confirm-' + filterIdx;
      var filterRemoveIdx = 'filter-remove-' + filterIdx;

      var opSelector = columnInfo[0].type == "string" ? textOpSelector : numOpSelector;
      opSelector.splice(1, 0, filterOpIdx);
      opSelector = opSelector.join("").replace("$", " ");

      filterRow.push('<li id="filter' + filterIdxClass + '" >')
      filterRow.push("<select class='filter-col " + filterColIdx + "' >")
      for (var i = 0; i < columnInfo.length; i++) {
        filterRow.push("<option value=" + columnInfo[i].name + ">" + columnTitles[i] + "</option>")
      }
      filterRow.push("</select>")
      filterRow.push(opSelector)
      filterRow.push('<input class="filter-value ' + filterValIdx + '" type="text"></input>')
      filterRow.push('<span class="filter-confirm ' + filterConfirmIdx + '">&#9989</span>');
      filterRow.push('<span class="filter-remove ' + filterRemoveIdx + '" >&#10006</span>');
      filterRow.push("</li>")
      filterRow = filterRow.join("");
      $("#add-filter").hide();
      $("#filters").append(filterRow);

      $('.filter-remove').hide();
      $('.filter-col').on('change', filterColEdited);
      $('.filter-op').on('change', filterOpEdited);
      $('.filter-value').on('input', function() {
        filterValEdited($(filterConfirmIdx), );
      });
      $('.' + filterConfirmIdx).on('click', function() {
        var column = $('.' + filterColIdx).val();
        var operator = $('.' + filterOpIdx).val();
        var value = $('.' + filterValIdx).val();
        $(this).hide();
        $('.' + filterRemoveIdx).show()

        $("#csv-table").tabulator("setFilter", column, operator, value);
      })

    }

    function filterColEdited() {
      var index = $(this).parent().prevAll().length;
      $('.filter-op').replaceWith();
    }

    function filterOpEdited() {
      console.log("edit");
    }

    function filterValEdited(confirmEle) {
      confirmEle.show();
    }

  </script>



</body>
</html>
